import json
import pandas as pd
import os
import random

# --- Configuration ---
# The name of the final file you will transfer to your training repo
FINAL_TRAINING_FILE = "setfit_training_data.json"

# List of the three newly generated JSON files to merge
GENERATED_FILES = [
    "generated_data/intent1.json", 
    "generated_data/intent2.json", 
    "generated_data/intent3.json" 
]

def consolidate_new_datasets():
    """
    Loads samples from all generated intent files, merges them into a single list, 
    shuffles the list, and creates the final training data JSON file.
    """
    print("="*60)
    print("üöÄ CONSOLIDATING GENERATED DATA FOR TRANSFER")
    print("="*60)
    
    all_samples = []
    total_new_samples = 0
    
    # 1. Load and Append Samples from all Generated Files
    for new_file in GENERATED_FILES:
        if os.path.exists(new_file):
            try:
                with open(new_file, 'r', encoding='utf-8') as f:
                    new_data = json.load(f)
                
                # Check that the loaded data is a list of samples
                if isinstance(new_data, list):
                    all_samples.extend(new_data)
                    total_new_samples += len(new_data)
                    print(f"‚úÖ Appended {len(new_data)} samples from {new_file}")
                else:
                    print(f"‚ö†Ô∏è Warning: {new_file} did not contain a list of samples. Skipping.")
            except Exception as e:
                 print(f"‚ùå Error reading {new_file}: {e}. Skipping.")
        else:
            print(f"‚ö†Ô∏è Warning: File not found: {new_file}. Skipping.")
    
    if total_new_samples == 0:
        print("üõë No new data was successfully loaded. Cannot create the final file.")
        return

    # 2. Shuffle the entire dataset (Crucial for SetFit)
    random.seed(42) # Ensure reproducible shuffling
    random.shuffle(all_samples)
    
    # 3. Create the final structured dictionary
    final_data_structure = {
        "metadata": "Synthetic data generated by Mistral-7B-Instruct for SetFit fine-tuning.",
        "training_data": all_samples
    }
    
    # 4. Save the Final JSON File
    print(f"\nWriting merged data to {FINAL_TRAINING_FILE}...")
    with open(FINAL_TRAINING_FILE, 'w', encoding='utf-8') as f:
        json.dump(final_data_structure, f, indent=2) 
    
    # 5. Final Verification
    df_final = pd.DataFrame(all_samples)
    print("\n--- ‚úÖ Consolidation Summary ---")
    print(f"Total Samples Generated and Saved: {total_new_samples}")
    
    print("\nFINAL Intent Distribution:")
    print(df_final['label'].value_counts().sort_index())
    
    print(f"\nüéâ CONSOLIDATION COMPLETE! The file '{FINAL_TRAINING_FILE}' is ready to be moved to your training repo.")

if __name__ == "__main__":
    consolidate_new_datasets()